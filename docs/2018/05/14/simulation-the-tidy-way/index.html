<!DOCTYPE html>
<html xmlns="http://www.w3.org/1999/xhtml" xml:lang="en" lang="en-us">

<head>
<title>R, it&#39;s OK I guess - Simulation, the tidy way</title>
  <meta http-equiv="content-type" content="text/html; charset=utf-8">

<meta name="viewport" content="width=device-width, initial-scale=1.0">
<meta name="description" content="">
<meta name="keywords" content="">
<meta name="author" content="R, it&#39;s OK I guess">
<meta name="generator" content="Hugo 0.26" />

  



<link rel="stylesheet" href="http://yui.yahooapis.com/pure/0.6.0/pure-min.css">


    <link rel="stylesheet" href="http://yui.yahooapis.com/pure/0.6.0/grids-responsive-min.css">








<link rel="stylesheet" href="https://maxcdn.bootstrapcdn.com/font-awesome/4.5.0/css/font-awesome.min.css">


<link rel="stylesheet" href="https://maxcdn.bootstrapcdn.com/bootstrap/3.3.7/css/bootstrap.min.css" integrity="sha384-BVYiiSIFeK1dGmJRAkycuHAHRg32OmUcww7on3RYdg4Va+PmSTsz/K68vbdEjh4u" crossorigin="anonymous">
<script src="https://maxcdn.bootstrapcdn.com/bootstrap/3.3.7/js/bootstrap.min.js" integrity="sha384-Tc5IQib027qvyjSMfHjOMaLkfuWVxZxUPnCJA7l2mCWNIpG9mGCD8wGNIcPD7Txa" crossorigin="anonymous"></script>


<link rel="stylesheet" href="../../../../css/tuftesque.css">

</head>

<body>
<div id="layout" class="pure-g">
<article class="pure-u-1">
<header class="brand">
  <h1>
    <a href="../../../../">
      <span id = "blog_logo">
        
          <img src=http://www.utsc.utoronto.ca/~butler/156-front.jpg alt="Blog Logo" style="height: 40px; width:40px">
        
      </span>
      
    </a>
  </h1>
</header>

<section>
  <h1 class="content-title">
  
  <a href="../../../../2018/05/14/simulation-the-tidy-way/">Simulation, the tidy way</a>
  
  </h1>
  
  
  
  <span class="content-meta">
    
  
  
  
  <i class="fa fa-user">&nbsp;</i><span class="author">
    &nbsp;Ken</span> <br>
    
  
  
  
  <i class="fa fa-calendar"></i>
    &nbsp;May 14, 2018
  
  
  
  &nbsp;<i class="fa fa-clock-o"></i>
    &nbsp;6 min read
  
  
  
  <br>
    <i class="fa fa-tags"> </i>
    
    <a  href="../../../../categories/r">R</a>
    
    <a  href="../../../../categories/statistics">statistics</a>
    
    
    </span>
    
    
    </section>


<section><div id="packages" class="section level2">
<h2>Packages</h2>
<p>I’m using this, and also doing some random number generation, which I’d like to be reproducible:</p>
<pre class="r"><code>library(tidyverse)</code></pre>
<pre><code>## ── Attaching packages ────────────────────────────────────────────────────────────────────────────────────── tidyverse 1.2.1 ──</code></pre>
<pre><code>## ✔ ggplot2 2.2.1.9000     ✔ purrr   0.2.4     
## ✔ tibble  1.4.2          ✔ dplyr   0.7.4     
## ✔ tidyr   0.8.0          ✔ stringr 1.3.0     
## ✔ readr   1.1.1          ✔ forcats 0.3.0</code></pre>
<pre><code>## ── Conflicts ───────────────────────────────────────────────────────────────────────────────────────── tidyverse_conflicts() ──
## ✖ dplyr::filter() masks stats::filter()
## ✖ dplyr::lag()    masks stats::lag()</code></pre>
<pre class="r"><code>set.seed(457299)</code></pre>
</div>
<div id="introduction" class="section level2">
<h2>Introduction</h2>
<p>I have been used to using the base R <code>replicate</code> for doing simulations, but today I wondered whether there was a Tidyverse equivalent. I discovered there was, and it’s called <code>rerun</code>. How does it work, and can I reproduce the simulation functionality using <code>rerun</code>?</p>
</div>
<div id="replicate" class="section level2">
<h2>Replicate</h2>
<p><code>replicate</code> does the second input as many times as the first input.
This one takes 100 random standard normals, computes the mean, and repeats this 10 times.</p>
<pre class="r"><code>replicate(10,mean(rnorm(100)))</code></pre>
<pre><code>##  [1] -0.02321398 -0.10763691 -0.13426106  0.06036594  0.08555731
##  [6]  0.05796492  0.04646084 -0.06750808 -0.04888533  0.07231331</code></pre>
<p>The sample mean of a sample of 100 <span class="math inline">\(N(0,1)\)</span> values has mean 0 and SD <span class="math inline">\(1/\sqrt{100}=0.1\)</span>, so 95% of values like these should be between <span class="math inline">\(\pm 0.2\)</span>. That seems to match these values.</p>
</div>
<div id="the-tidy-way-with-map" class="section level2">
<h2>The tidy way with <code>map</code></h2>
<p>I would do this the tidy way by creating a column with the replication numbers, then using <code>map</code> to generate the random samples, following up with another <code>map</code> to compute their means:</p>
<pre class="r"><code>tibble(rep=1:10) %&gt;% 
  mutate(samples=map(rep,~rnorm(100))) %&gt;% 
  mutate(means=map_dbl(samples,~mean(.)))</code></pre>
<pre><code>## # A tibble: 10 x 3
##      rep samples       means
##    &lt;int&gt; &lt;list&gt;        &lt;dbl&gt;
##  1     1 &lt;dbl [100]&gt;  0.184 
##  2     2 &lt;dbl [100]&gt; -0.0238
##  3     3 &lt;dbl [100]&gt; -0.0163
##  4     4 &lt;dbl [100]&gt; -0.0798
##  5     5 &lt;dbl [100]&gt;  0.0842
##  6     6 &lt;dbl [100]&gt;  0.0624
##  7     7 &lt;dbl [100]&gt;  0.0179
##  8     8 &lt;dbl [100]&gt; -0.0873
##  9     9 &lt;dbl [100]&gt; -0.125 
## 10    10 &lt;dbl [100]&gt; -0.0728</code></pre>
<p>The column called <code>samples</code> is a list-column: each entry is a vector of 100 values. The list-column is created using <code>map</code>, and is then used as input to the calculation of the single-number (each time) mean using a second <code>map</code>, this time a <code>map_dbl</code>.</p>
<p>The answers are different from but comparable with the ones from <code>replicate</code>.</p>
<p>The column <code>rep</code> is only to label different replications of the same thing, so the first <code>map</code> does <em>not</em> have a dot in it (“for each <code>rep</code>, generate 100 random standard normals for which nothing depends on the value of <code>rep</code>”). The <code>map_dbl</code> in the next line, however, is the usual “for each thing in <code>samples</code>, do something with <em>it</em>”, and so the dot is used to mean “the particular random sample we are looking at right now, whose mean we want”.</p>
</div>
<div id="rerun" class="section level2">
<h2><code>rerun</code></h2>
<p>Defining the column <code>rep</code>, as we did above, is in fact almost completely pointless. The only use of that column is to say that we want 10 repeats of the random sampling process, and that information could be just as easily conveyed by the number 10. This is how <code>rerun</code> works:</p>
<pre class="r"><code>rerun(10,rnorm(100)) %&gt;% 
  map_dbl(~mean(.))</code></pre>
<pre><code>##  [1] -0.01464278  0.07959040  0.12642268  0.11989901  0.05910164
##  [6]  0.06355798 -0.13927125  0.02277575 -0.14046121  0.14216426</code></pre>
<p>The output of this <code>rerun</code> is a <code>list</code> containing 10 random samples of size 100 each, and then the <code>map_dbl</code> calculates the mean of each of these (each list element, in general) returning a vector of 10 sample means.</p>
<p>For full tidiness, this ought to be done in a data frame. The output from <code>rerun</code>, though, is a list. If you convert it into a <code>tibble</code>, it comes across as a data frame with one column for each list element with <em>no names</em>, so I have to supply some:</p>
<pre class="r"><code>rerun(10,rnorm(100)) %&gt;% 
  as_tibble(validate=F) -&gt; 
z
names(z)=str_c(&quot;X&quot;,sprintf(&quot;%02d&quot;,1:10))
z</code></pre>
<pre><code>## # A tibble: 100 x 10
##         X01    X02    X03    X04     X05     X06    X07     X08    X09
##       &lt;dbl&gt;  &lt;dbl&gt;  &lt;dbl&gt;  &lt;dbl&gt;   &lt;dbl&gt;   &lt;dbl&gt;  &lt;dbl&gt;   &lt;dbl&gt;  &lt;dbl&gt;
##  1  1.12    -0.734  2.01   0.124  0.978  -1.47   -1.60  -0.0530 -0.432
##  2  0.148    0.485  0.479 -0.448 -0.0324  0.332   0.767  2.02   -0.627
##  3  0.00855 -0.704  0.855  0.702 -1.70    0.277  -0.817  0.814   0.790
##  4 -0.739    0.532  1.79  -1.28  -0.575  -0.629   0.552 -2.88    0.282
##  5  0.986   -0.409 -0.465  2.84  -0.628   1.12   -1.74  -0.816   0.905
##  6 -0.941    0.502 -0.412  0.722  0.599   1.05    0.568  0.349   0.353
##  7 -0.917    0.169 -1.38  -0.891  1.60   -0.510   0.251 -0.209   1.17 
##  8  0.0183  -0.555  0.232  0.234  0.271  -0.856   0.184  0.337   0.121
##  9  0.519   -0.576  0.816  0.524 -0.216  -0.0174  1.30  -0.676   0.381
## 10  0.949   -0.211  0.406  0.391 -0.0616 -1.96    1.63  -0.903   0.807
## # ... with 90 more rows, and 1 more variable: X10 &lt;dbl&gt;</code></pre>
<p>This gives a couple of ways of extracting the sample means:</p>
<pre class="r"><code>z %&gt;% summarize_all(mean)</code></pre>
<pre><code>## # A tibble: 1 x 10
##       X01    X02    X03    X04     X05     X06    X07     X08   X09    X10
##     &lt;dbl&gt;  &lt;dbl&gt;  &lt;dbl&gt;  &lt;dbl&gt;   &lt;dbl&gt;   &lt;dbl&gt;  &lt;dbl&gt;   &lt;dbl&gt; &lt;dbl&gt;  &lt;dbl&gt;
## 1 -0.0153 0.0327 0.0654 0.0208 -0.0169 9.63e⁻⁴ 0.0120 0.00647 0.101 0.0874</code></pre>
<p>Or we can gather the columns into one and use the column names as the grouping variable:</p>
<pre class="r"><code>z %&gt;% gather(col_name,value,everything()) %&gt;% 
  group_by(col_name) %&gt;% 
  summarize(means=mean(value))</code></pre>
<pre><code>## # A tibble: 10 x 2
##    col_name     means
##    &lt;chr&gt;        &lt;dbl&gt;
##  1 X01      -0.0153  
##  2 X02       0.0327  
##  3 X03       0.0654  
##  4 X04       0.0208  
##  5 X05      -0.0169  
##  6 X06       0.000963
##  7 X07       0.0120  
##  8 X08       0.00647 
##  9 X09       0.101   
## 10 X10       0.0874</code></pre>
</div>
<div id="power-of-t-test" class="section level2">
<h2>Power of <span class="math inline">\(t\)</span>-test</h2>
<p>To simulate the power of a hypothesis test, the process is to simulate a lot of samples from the true (alternative) distribution, and test the null hypothesis (which is incorrect) for each one. The number of times you correctly reject is your estimate of the power of your test. The idea is that you want your test to have a reasonably good chance that it will reject the null, or to design your study so that it will.</p>
<p>By way of example, how likely are we to reject a null hypothesis that the population mean is 10, if the population mean is actually 8 (and the population standard deviation is 4), using a sample size of <span class="math inline">\(n=15\)</span>, assuming normally-distributed data and doing a two-sided test? With 1000 simulated samples, it goes like this:</p>
<pre class="r"><code>rerun(1000,rnorm(15,8,4)) %&gt;% 
  map_dbl(~t.test(.,mu=10)$p.value) -&gt; 
pvals
table(pvals&lt;=0.05)</code></pre>
<pre><code>## 
## FALSE  TRUE 
##   573   427</code></pre>
<p>The power is estimated to be a disappointing 0.427.</p>
<p>This is one of those cases where we can calculate the answer exactly and compare:</p>
<pre class="r"><code>power.t.test(n=15,delta=8-10,sd=4,type=&quot;one.sample&quot;,alternative=&quot;two.sided&quot;)</code></pre>
<pre><code>## 
##      One-sample t test power calculation 
## 
##               n = 15
##           delta = 2
##              sd = 4
##       sig.level = 0.05
##           power = 0.4378466
##     alternative = two.sided</code></pre>
<p>Our simulation is pretty close to the truth.</p>
<p>If the actual data distribution is not normal, though, we <em>have</em> to resort to simulation. Supposing that the true distribution is gamma with <span class="math inline">\(a=(8/4)^2=4\)</span>, <span class="math inline">\(b=8/4^2=0.5\)</span>, it will have the same mean and SD of 8 and 4. This is definitely skewed, though:</p>
<pre class="r"><code>x=rgamma(1000,4,0.5)
ggplot(tibble(x),aes(x=x)) + geom_histogram(bins=15)</code></pre>
<p><img src="../../../../post/2018-05-14-simulation-the-tidy-way_files/figure-html/unnamed-chunk-10-1.png" width="672" /></p>
<p>What will that do to the power? Let’s find out:</p>
<pre class="r"><code>rerun(1000,rgamma(15,4,0.5)) %&gt;% 
  map_dbl(~t.test(.,mu=10)$p.value) -&gt; 
pvals
table(pvals&lt;=0.05)</code></pre>
<pre><code>## 
## FALSE  TRUE 
##   513   487</code></pre>
<p>The power has gone up a bit (it was 0.438 before). You may speculate as to why that is.</p>
</div>
<div id="references" class="section level2">
<h2>References</h2>
<p><a href="https://purrr.tidyverse.org/reference/rerun.html">The “rerun” help page</a></p>
<p><a href="https://math.stackexchange.com/questions/1810257/gamma-functions-mean-and-standard-deviation-through-shape-and-rate">Getting the gamma parameters from mean and SD</a>, because I was too lazy to work it out myself.</p>
</div>
</section>
<section>
  

  



  <div id="disqus_thread"></div>
<script>
(function() {
var d = document, s = d.createElement('script');
s.src = 'https://kens-blog-2.disqus.com/embed.js';
s.setAttribute('data-timestamp', +new Date());
(d.head || d.body).appendChild(s);
})();
</script>
<noscript>Please enable JavaScript to view the <a href="https://disqus.com/?ref_noscript">comments powered by Disqus.</a></noscript>

  <footer class="page-footer">
		<hr>
		<ul class="page-footer-menu">
		
		</ul>

  

	<div class="copyright">
	<p>
    
      &copy; 2018
    .
    All rights reserved.
    
  </p>
</div>
<script type="text/x-mathjax-config">
    MathJax.Hub.Config({
      tex2jax: {
        skipTags: ['script', 'noscript', 'style', 'textarea', 'pre']
      }
    });
    </script>
    <script type="text/javascript"
      src="https://cdn.mathjax.org/mathjax/latest/MathJax.js?config=TeX-AMS-MML_HTMLorMML">
    </script>
</footer>

</section>
</article>
</div>
</body>
</html>
